<%*
/*
ç›®çš„ï¼š
- éå»7æ—¥ä»¥å†…ã«ä½œæˆã•ã‚ŒãŸãƒãƒ¼ãƒˆã‚’å–å¾—ã™ã‚‹
  - ä½œæˆæ—¥ãŒéå»7æ—¥ä»¥å†…ã®ãƒãƒ¼ãƒˆ â†’ é€šå¸¸ãƒªã‚¹ãƒˆ
  - æ›´æ–°æ—¥ãŒéå»7æ—¥ä»¥å†…ã®ãƒãƒ¼ãƒˆ â†’ ã€Œ## Updatedã€é…ä¸‹ã«ãƒªã‚¹ãƒˆ
  ã‚’åˆ†ã‘ã¦è¡¨ç¤ºã™ã‚‹
*/

const createdHeader = `
<div style="border-top: solid medium blue; border-bottom: solid medium blue; text-align: center;">
    <font size="6"><strong>
        ğŸ“šCreated Notes (Within 7 Days)
    </strong></font>
</div>
`;

const updatedHeader = `
<div style="border-top: solid medium orange; border-bottom: solid medium orange; text-align: center;">
    <font size="6"><strong>
        âœ’Updated Notes (Within 7 Days)
    </strong></font>
</div>
`;

// ---------- éå»7æ—¥ã®ç¯„å›²ã‚’æ±ºå®š ----------

const sevenDaysAgo = moment().subtract(7, 'days').startOf('day');
const today = moment().endOf('day');

// ---------- åˆ¤å®šé–¢æ•° ----------

// ä½œæˆæ—¥åˆ¤å®šï¼ˆéå»7æ—¥ä»¥å†…ï¼‰
const isCreatedWithin7Days = (file, sevenDaysAgo, today) =>
  file.stat && moment(file.stat.ctime).isBetween(sevenDaysAgo, today, null, '[]');

// æ›´æ–°æ—¥åˆ¤å®šï¼ˆéå»7æ—¥ä»¥å†…ï¼‰
const isUpdatedWithin7Days = (file, sevenDaysAgo, today) =>
  file.stat && moment(file.stat.mtime).isBetween(sevenDaysAgo, today, null, '[]');

// å…¬é–‹ãƒãƒ¼ãƒˆåˆ¤å®š
const isPublicNote = (file) =>
  !file.path.startsWith("_") && file.extension === "md";

// ---------- ãƒ•ã‚¡ã‚¤ãƒ«å–å¾— ----------

let files = this.app.vault.getFiles()
  .sort((a, b) => a.basename.localeCompare(b.basename));

// ---------- ä½œæˆãƒãƒ¼ãƒˆï¼ˆéå»7æ—¥ä»¥å†…ï¼‰ ----------

const createdFiles = files.filter(file =>
  isPublicNote(file) &&
  isCreatedWithin7Days(file, sevenDaysAgo, today)
);

if (createdFiles.length > 0) {
  tR += "\n" + createdHeader + "\n";
  tR += createdFiles
    .map(file => `- [[${file.basename}]]`)
    .join("\n");
}

// ---------- æ›´æ–°ãƒãƒ¼ãƒˆï¼ˆéå»7æ—¥ä»¥å†…ï¼‰ ----------

const updatedFiles = files.filter(file =>
  isPublicNote(file) &&
  !isCreatedWithin7Days(file, sevenDaysAgo, today) &&
  isUpdatedWithin7Days(file, sevenDaysAgo, today)
);

if (updatedFiles.length > 0) {
  tR += "\n\n" + updatedHeader + "\n";
  tR += updatedFiles
    .map(file => `- [[${file.basename}]]`)
    .join("\n");
}
%>
